#!/bin/bash
set -ex
DESTINATION_TOOLCHAIN=$1
LLVM_BIN_DIR=$2
CLANG_BIN_DIR=$3
SWIFT_BIN_DIR=$4
WASI_SYSROOT_PATH=$5

SOURCE_PATH="$(cd "$(dirname $0)/../../.." && pwd)"
TOOLS_BUILD_PATH="$(cd "$(dirname "$0")" && pwd)"
BUILD_SDK_PATH="$SOURCE_PATH/build-sdk"
LIBXML2_PATH="$BUILD_SDK_PATH/libxml2"

FOUNDATION_BUILD="$SOURCE_PATH/build/WebAssembly/foundation-wasi-wasm32"

mkdir -p $FOUNDATION_BUILD
cd $FOUNDATION_BUILD

cmake -G Ninja \
  -DCMAKE_BUILD_TYPE="Release" \
  -DCMAKE_SYSROOT="$WASI_SYSROOT_PATH" \
  -DCMAKE_Swift_COMPILER="$SWIFT_BIN_DIR/swiftc" \
  -DCMAKE_STAGING_PREFIX="$DESTINATION_TOOLCHAIN/usr" \
  -DCMAKE_TOOLCHAIN_FILE="$TOOLS_BUILD_PATH/toolchain-wasi.cmake" \
  -DLLVM_BIN="$LLVM_BIN_DIR" \
  -DCLANG_BIN="$CLANG_BIN_DIR" \
  -DICU_ROOT="$BUILD_SDK_PATH/icu" \
  -DLIBXML2_INCLUDE_DIR="$LIBXML2_PATH/include/libxml2" \
  -DLIBXML2_LIBRARY="$LIBXML2_PATH/lib" \
  -DBUILD_SHARED_LIBS=OFF \
  -DBUILD_NETWORKING=OFF \
  -DBUILD_TOOLS=OFF \
  -DFOUNDATION_ENABLE_FOUNDATION_NETWORKING=OFF \
  -DFOUNDATION_BUILD_TOOLS=OFF \
  -DHAS_LIBDISPATCH_API=OFF \
  -DCMAKE_Swift_COMPILER_FORCED=ON \
  -DCMAKE_Swift_FLAGS="-sdk $WASI_SYSROOT_PATH -resource-dir $DESTINATION_TOOLCHAIN/usr/lib/swift_static" \
  -DCMAKE_C_FLAGS="-resource-dir $DESTINATION_TOOLCHAIN/usr/lib/swift_static/clang -B $LLVM_BIN_DIR" \
  "${SOURCE_PATH}/swift-corelibs-foundation"
  
ninja
ninja install
