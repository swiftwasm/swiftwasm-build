From 7ccef0d98d0d2014da85bae2064b603fc7c63956 Mon Sep 17 00:00:00 2001
From: Tony Parker <anthony.parker@apple.com>
Date: Thu, 8 Aug 2024 11:53:00 -0700
Subject: [PATCH] Allow for more flexibility in what path
 SWIFTCI_USE_LOCAL_DEPS means (#5048)

---
 Package.swift | 28 ++++++++++++++++++----------
 1 file changed, 18 insertions(+), 10 deletions(-)

diff --git a/Package.swift b/Package.swift
index 1477aefd..c7c35610 100644
--- a/Package.swift
+++ b/Package.swift
@@ -101,24 +101,33 @@ let interfaceBuildSettings: [CSetting] = [
 let swiftBuildSettings: [SwiftSetting] = [
     .define("DEPLOYMENT_RUNTIME_SWIFT"),
     .define("SWIFT_CORELIBS_FOUNDATION_HAS_THREADS"),
-    .swiftLanguageVersion(.v6),
+    .swiftLanguageMode(.v6),
     .unsafeFlags([
         "-Xfrontend",
         "-require-explicit-sendable",
     ])
 ]
 
-var dependencies: [Package.Dependency] {
-    if Context.environment["SWIFTCI_USE_LOCAL_DEPS"] != nil {
+var dependencies: [Package.Dependency] = []
+
+if let useLocalDepsEnv = Context.environment["SWIFTCI_USE_LOCAL_DEPS"] {
+    let root: String
+    if useLocalDepsEnv == "1" {
+        root = ".."
+    } else {
+        root = useLocalDepsEnv
+    }
+    dependencies += 
         [
             .package(
                 name: "swift-foundation-icu",
-                path: "../swift-foundation-icu"),
+                path: "\(root)/swift-foundation-icu"),
             .package(
                 name: "swift-foundation",
-                path: "../swift-foundation")
+                path: "\(root)/swift-foundation")
         ]
-    } else {
+} else {
+    dependencies += 
         [
             .package(
                 url: "https://github.com/apple/swift-foundation-icu",
@@ -127,7 +136,6 @@ var dependencies: [Package.Dependency] {
                 url: "https://github.com/apple/swift-foundation",
                 branch: "main")
         ]
-    }
 }
 
 let package = Package(
@@ -244,7 +252,7 @@ let package = Package(
                 "CMakeLists.txt"
             ],
             swiftSettings: [
-                .swiftLanguageVersion(.v6)
+                .swiftLanguageMode(.v6)
             ]
         ),
         .executableTarget(
@@ -255,7 +263,7 @@ let package = Package(
                 "FoundationNetworking"
             ],
             swiftSettings: [
-                .swiftLanguageVersion(.v6)
+                .swiftLanguageMode(.v6)
             ]
         ),
         .target(
@@ -283,7 +291,7 @@ let package = Package(
             ],
             swiftSettings: [
                 .define("NS_FOUNDATION_ALLOWS_TESTABLE_IMPORT"),
-                .swiftLanguageVersion(.v6)
+                .swiftLanguageMode(.v6)
             ]
         ),
     ]
-- 
2.43.2

